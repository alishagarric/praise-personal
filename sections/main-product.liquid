{{ 'product.css' | asset_url | stylesheet_tag }}
{{ 'component-price.css' | asset_url | stylesheet_tag }}

{% style %}
  --topSpacingRatio: {{ section.settings.top_spacing }} / 100;
  --bottomSpacingRatio: {{ section.settings.bottom_spacing }} / 100;
{% endstyle %}


{% comment %} 
  Get these variables:
   featured_media (object)
   variant_images (array)
   media_count (int)
   first_3d_modal (object)

   TODO: What is section.settings.hide_variants below. Create it in schema? Remove it here?
{% endcomment %}
{%- liquid
  assign featured_media = product.selected_or_first_available_variant.featured_media
  assign variant_images = product.images | where: 'attached_to_variant?', true | map: 'src'
  assign media_count = product.media.size
  if section.settings.hide_variants and media_count > 1
    assign media_count = media_count | minus: variant_images.size | plus: 1
  endif
  assign first_3d_model = product.media | where: "media_type", "model" | first
-%}


{% comment %} Add style sheet that'll apply to 3d model instances? {% endcomment %}
{%- if first_3d_model -%}
  <link id="ModelViewerStyle" rel="stylesheet" href="https://cdn.shopify.com/shopifycloud/model-viewer-ui/assets/v1.0/model-viewer-ui.css" media="print" onload="this.media='all'">
{%- endif -%}

<div class="main-product product __theme-{{ section.settings.theme }}" style="--color-background: {{ product.metafields.custom.color.value.rgb }}; --color-text: {{ product.metafields.custom.text_color.value.rgb }};">

    {% comment %} Product info {% endcomment %}
    <div id="Product-Info-{{ section.id }}" class="main-product__container">
      {%- assign product_form_id = 'Product-Form-' | append: section.id -%}

      {% comment %} 
        Seems weird but we need to open this container without a closing tag. 
        Either the end of the loop of the media block within the loop will close 
        this div. Goal here is to contain all blocks that are ordered before the media block.
      {% endcomment %}
      <div class="main-product__blocks-before-media"> 

      {% comment %} Loop through blocks {% endcomment %}
      {%- for block in section.blocks -%}
        {%- case block.type -%}

        {% comment %} Type media {% endcomment %}
        {%- when 'media' -%}
          {% comment %}
            Seems weird, but this closes the "blocks-before-media" opening div tag above
            so that all blocks ordered before media are in a container
          {% endcomment %}
          </div>

          <div class="main-product__media">
            <media-gallery id="Product-MediaGallery-{{ section.id }}" class="__side-center">

              {% comment %} Skip to content anchor link {% endcomment %}
              <a class="skip-to-content-link visually-hidden" href="#ProductInfo-{{ section.id }}">
                {{ 'accessibility.skip_to_product_info' | t }}
              </a>

              <ul class="product-media grid list-unstyled" role="list">

                {% comment %} If no media exists, output placeholder content? {% endcomment %}
                {%- unless featured_media == null -%}
                  <li data-media-id="{{ section.id }}-{{ featured_media.id }}">
                    {% render 'product-thumbnail', media: featured_media, loading: 'eager' %}
                  </li>
                {%- endunless -%}

                {% comment %} Loop through available media, excluding featured media item {% endcomment %}
                {% comment %} What does the parent <media-gallery> component do, why do these li's have data-media-id attr on them? {% endcomment %}
                {%- for media in product.media -%}
                  {%- unless media.id == featured_media.id -%}
                    <li data-media-id="{{ section.id }}-{{ media.id }}">
                      {%- liquid
                        assign media_position = media_position | default: 0 | plus: 1
                        assign loading = 'eager'
                        if media_position > 1
                          assign loading = 'lazy'
                        endif
                        render 'product-thumbnail', media: media, loading: loading
                      -%}
                    </li>
                  {%- endunless -%}
                {%- endfor -%}
              </ul>
            </media-gallery>
          </div>

          {% comment %}
            Seems weird but we need to open this container without a closing tag. 
            The end of the loop will close this div so that all blocks after media are in a container
          {% endcomment %}
          <div class="main-product__blocks-after-media __theme-{{ section.settings.theme }}">
          


        {% comment %} Type app {% endcomment %}
          {%- when '@app' -%}
            <div class="app __side-left">
            {% render block %}

          {% comment %} Type text {% endcomment %}
          {%- when 'text' -%}
            <p {{ block.shopify_attributes }}>
              {{ block.settings.text }}
            </p>

          {% comment %} Type title {% endcomment %}
          {%- when 'title' -%}
            {% assign heading = product.title | escape %}
            {% render 'heading', heading: heading, alt_heading: block.settings.alt_heading, heading_size: block.settings.heading_size, use_as_hero: true %}

          {% comment %} Type price, What is this no-js-hidden class below? {% endcomment %}
          {%- when 'price' -%}
            <div
              id="Price-{{ section.id }}"
              class="no-js-hidden" 
              role="status"
              {{ block.shopify_attributes }}
            >
              {%- render 'price', product: product, use_variant: true, show_badges: true -%}
            </div>
            {%- if shop.taxes_included or shop.shipping_policy.body != blank -%}
              <div>
                {%- if shop.taxes_included -%}
                  {{ 'products.product.include_taxes' | t }}
                {%- endif -%}
                {%- if shop.shipping_policy.body != blank -%}
                  {{ 'products.product.shipping_policy_html' | t: link: shop.shipping_policy.url }}
                {%- endif -%}
              </div>
            {%- endif -%}
            <div {{ block.shopify_attributes }}>
              {%- assign installment_id = 'Installment-' | append: section.id -%}
              {%-
                form 'product',
                product,
                id: installment_id
              -%}
                <input
                  type="hidden"
                  name="id"
                  value="{{ product.selected_or_first_available_variant.id }}"
                >
                {{ form | payment_terms }}
              {%- endform -%}
            </div>

          {% comment %} Type Quantity Selector {% endcomment %}
          {%- when 'quantity_selector' -%}
            <div {{ block.shopify_attributes }}>
              <label for="Quantity-{{ section.id }}">
                {{ 'products.product.quantity.label' | t }}
              </label>
              <input
                type="number"
                name="quantity"
                id="Quantity-{{ section.id }}"
                min="1"
                value="1"
                form="{{ product_form_id }}"
              >
            </div>

          {% comment %} Type variant picker {% endcomment %}
          {%- when 'variant_picker' -%}
            {%- unless product.has_only_default_variant -%}
              <variant-selects class="no-js-hidden" data-section="{{ section.id }}" data-url="{{ product.url }}">
                {%- for option in product.options_with_values -%}
                  <div>
                    <label for="Option-{{ section.id }}-{{ forloop.index0 }}">
                      {{ option.name }}
                    </label>
                    <select
                      id="Option-{{ section.id }}-{{ forloop.index0 }}"
                      name="options[{{ option.name | escape }}]"
                      form="{{ product_form_id }}"
                    >
                      {%- for value in option.values -%}
                        <option
                          value="{{ value | escape }}"
                          {% if option.selected_value == value %}
                            selected="selected"
                          {% endif %}
                        >
                          {{ value }}
                        </option>
                      {%- endfor -%}
                    </select>
                  </div>
                {%- endfor -%}

                <script type="application/json">
                  {{ product.variants | json }}
                </script>
              </variant-selects>

              <noscript>
                <div>
                  <label for="Variants-{{ section.id }}">
                    {{ 'products.product.product_variants' | t }}
                  </label>

                  <select
                    name="id"
                    id="Variants-{{ section.id }}"
                    form="{{ product_form_id }}"
                  >
                    {%- for variant in product.variants -%}
                      <option
                        {% if variant == product.selected_or_first_available_variant %}
                          selected="selected"
                        {% endif %}
                        {% if variant.available == false %}
                          disabled
                        {% endif %}
                        value="{{ variant.id }}"
                      >
                        {{ variant.title }}
                        {%- if variant.available == false %}
                          - {{ 'products.product.sold_out' | t -}}
                        {%- endif %}
                        - {{ variant.price | money | strip_html }}
                      </option>
                    {%- endfor -%}
                  </select>
                </div>
              </noscript>
            {%- endunless -%}

          {% comment %} Type buy buttons {% endcomment %}
          {%- when 'buy_buttons' -%}
            <product-form {{ block.shopify_attributes }}>
              <div class="message-error" role="alert" hidden></div>

              {%-
                form 'product',
                product,
                id: product_form_id,
                class: 'product-form',
                novalidate: 'novalidate',
                data-type: 'add-to-cart-form'
              -%}
                <input
                  type="hidden"
                  name="id"
                  value="{{ product.selected_or_first_available_variant.id }}"
                  disabled
                >
                <div>
                  <button
                    type="submit"
                    name="add"
                    class="button btn"
                    style="--color-foreground: {{ product.metafields.custom.color.value.rgb }}; --color-foreground-text: {{ product.metafields.custom.text_color.value.rgb }}"
                    {% if product.selected_or_first_available_variant.available == false %}
                      disabled
                    {% endif %}
                  >
                    <span>
                      {%- if product.selected_or_first_available_variant.available -%}
                        {{ 'products.product.add_to_cart' | t }}
                      {%- else -%}
                        {{ 'products.product.sold_out' | t }}
                      {%- endif -%}
                    </span>

                    {% comment %} TODO: loading spinner {% endcomment %}
                  </button>

                  {% comment %} Dynamic checkout buttons {% endcomment %}
                  {{ form | payment_button }}
                </div>
              {%- endform -%}
            </product-form>

          {% comment %} Type expandable content {% endcomment %}
          {%- when 'expandable' %}
            {% render 'expandable-content', title: block.settings.title, id: block.id, text: block.settings.text, page: block.settings.page, open: block.settings.open %}

          {% comment %} Type featured icons {% endcomment %}
          {%- when 'icons' -%}
            <ul class="main-product__icons">
              {% for icon in product.metafields.custom.featured_icons.value %}
                <li class="main-product__icons__icon custom-icon-{{ icon | handleize }}">
                  {{ icon }}
                </li>
              {% endfor %}
            </ul>

          {% comment %} Type description {% endcomment %}
          {%- when 'description' -%}
            {%- unless product.description == blank -%}
              <div {{ block.shopify_attributes }} class="p-sm">
                {{ product.description }}
              </div>
            {%- endunless -%}

          {% comment %} Type rating {% endcomment %}
          {%- when 'rating' -%}
            {%- unless product.metafields.reviews.rating.value == blank -%}
              <p class="rating">
                {{- 'products.product.star_reviews_info' | t: rating_value: product.metafields.reviews.rating.value, rating_max: product.metafields.reviews.rating.value.scale_max }}
                <span>
                  {{- product.metafields.reviews.rating_count }}
                  {{ 'products.product.total_reviews' | t -}}
                </span>
              </p>
            {%- endunless -%}

          {% comment %} Type pickup availability {% endcomment %}
          {%- when 'pickup_availability' -%}
            {% comment %}
              Pickup availability block's contents are rendered async to ensure faster Liquid render times, but this may cause a noticeable increase in cumulative layout shift (CLS) if rendered near the top of the page.
              To mitigate CLS, the contents of `pickup-availability.liquid` could alternatively be rendered directly in this Liquid file.
            {% endcomment %}
            <script src="{{ 'pickup-availability.js' | asset_url }}" defer="defer"></script>
            <pickup-availability data-product-variant="{{ product.selected_or_first_available_variant.id }}">
              {% comment %}
                Error template is rendered if async request for pickup availability fails
              {% endcomment %}
              <template>
                <p class="message-error">{{ 'products.pickup_availability.error' | t }}</p>
              </template>
            </pickup-availability>
        {%- endcase -%}
      {%- endfor -%}

      {% comment %}
        Seems weird, but this closes the "blocks-before-media" or "blocks-after-media" 
        opening div tag above depending on if the media block exists or not. This is
        so that all blocks ordered after media are in a container
      {% endcomment %}
      </div>
    </div>
  </div>

  {% comment %} TODO: IE purchase flow fix {% endcomment %}
  {% comment %} TODO: SEO JSON {% endcomment %}
  {%- if first_3d_model -%}
    <script type="application/json" id="Product-JSON-{{ product.id }}">
      {{ product.media | where: 'media_type', 'model' | json }}
    </script>
    <script src="{{ 'product-model.js' | asset_url }}" defer></script>
  {%- endif -%}
</div>

<script src="{{ 'media-gallery.js' | asset_url }}" defer="defer"></script>
<script src="{{ 'variant-selects.js' | asset_url }}" defer="defer"></script>
<script src="{{ 'product-form.js' | asset_url }}" defer="defer"></script>

{% schema %}
{
  "name": "t:sections.main-product.name",
  "tag": "section",
  "class": "section",
  "blocks": [
    {
      "type": "@app"
    },
    {
      "type": "text",
      "name": "t:sections.main-product.blocks.text.name",
      "settings": [
        {
          "type": "text",
          "id": "text",
          "default": "Text block",
          "label": "t:sections.main-product.blocks.text.settings.text.label"
        }
      ]
    },
    {
      "type": "expandable",
      "name": "Expandable Content",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "default": "Title",
          "label": "Title"
        },
        {
          "type": "richtext",
          "id": "text",
          "label": "Text"
        },
        {
          "type": "page",
          "id": "page",
          "label": "Text from a page"
        },
        {
          "type": "checkbox",
          "id": "open",
          "label": "Open"
        }
      ]
    },
    {
      "type": "icons",
      "limit": 1,
      "name": "Featured Icons",
      "settings": [
        {
          "type": "paragraph",
          "content": "This are generated from the featured icons product metafield. Learn More TODO: link this to a description. You can add additional featured icons below."
        },
        {
          "type": "select",
          "id": "icon_1",
          "options": [
            {
              "value": "none",
              "label": "None"
            },
            {
              "value": "recycle",
              "label": "Recycle"
            },
            {
              "value": "delivery-truck",
              "label": "Delivery Truck"
            }
          ],
          "default": "none",
          "label": "Icon 1"
        },
        {
          "type": "text",
          "id": "icon_1_title",
          "label": "Icon 2 Title"
        },
        {
          "type": "select",
          "id": "icon_2",
          "options": [
            {
              "value": "none",
              "label": "None"
            },
            {
              "value": "recycle",
              "label": "Recycle"
            },
            {
              "value": "delivery-truck",
              "label": "Delivery Truck"
            }
          ],
          "default": "none",
          "label": "Icon 2"
        },
        {
          "type": "text",
          "id": "icon_2_title",
          "label": "Icon 3 Title"
        },
        {
          "type": "select",
          "id": "icon_3",
          "options": [
            {
              "value": "none",
              "label": "None"
            },
            {
              "value": "recycle",
              "label": "Recycle"
            },
            {
              "value": "delivery-truck",
              "label": "Delivery Truck"
            }
          ],
          "default": "none",
          "label": "Icon 3"
        },
        {
          "type": "text",
          "id": "icon_3_title",
          "label": "Icon 3 Title"
        }
      ]
    },
    {
      "type": "media",
      "name": "media",
      "limit": 1
    },
    {
      "type": "title",
      "name": "t:sections.main-product.blocks.title.name",
      "limit": 1, 
      "settings": [
        {
            "type": "select",
            "id": "heading_size",
            "options": [
              {
                  "value": "h1",
                  "label": "X-Large"
              },
              {
                  "value": "h2",
                  "label": "Large"
              },
              {
                  "value": "h3",
                  "label": "Medium"
              },
              {
                  "value": "h4",
                  "label": "Small"
              }
            ],
            "default": "h2",
            "label": "Heading Size"
        },
        {
          "type": "checkbox",
          "id": "alt_heading",
          "label": "Use body font instead of heading font for heading?"
        }
      ]
    },
    {
      "type": "price",
      "name": "t:sections.main-product.blocks.price.name",
      "limit": 1
    },
    {
      "type": "quantity_selector",
      "name": "t:sections.main-product.blocks.quantity_selector.name",
      "limit": 1
    },
    {
      "type": "variant_picker",
      "name": "t:sections.main-product.blocks.variant_picker.name",
      "limit": 1
    },
    {
      "type": "buy_buttons",
      "name": "t:sections.main-product.blocks.buy_buttons.name",
      "limit": 1
    },
    {
      "type": "description",
      "name": "t:sections.main-product.blocks.description.name",
      "limit": 1
    },
    {
      "type": "rating",
      "name": "t:sections.main-product.blocks.rating.name",
      "limit": 1,
      "settings": [
        {
          "type": "paragraph",
          "content": "t:sections.main-product.blocks.rating.settings.paragraph.content"
        }
      ]
    },
    {
      "type": "pickup_availability",
      "name": "Pickup availability",
      "limit": 1
    }
  ],
  "settings": [
    {
      "type": "header",
      "content": "Section"
    },
    {
      "type": "select",
      "id": "theme",
      "options": [
        {
          "value": "primary",
          "label": "Primary Theme"
        },
        {
          "value": "2",
          "label": "2nd Theme"
        },
        {
          "value": "3",
          "label": "3rd Theme"
        },
        {
          "value": "4",
          "label": "4th Theme"
        },
        {
          "value": "5",
          "label": "5th Theme"
        }
      ],
      "default": "primary",
      "label": "Theme",
      "info": "Theme"
    }
  ]
}
{% endschema %}